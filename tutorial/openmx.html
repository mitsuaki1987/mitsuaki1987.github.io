<html>
  <head>
    <meta http-equiv="Content-Type" 
          content="text/html; charset=utf-8">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
    </script>
    <script type="text/javascript"
            src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
    </script>
    <meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
    
    <title>OpenMXチュートリアル</title>
    
    <meta name="description" content="河村光晶HomePage">
    
  </head>
  <body bgcolor="CCFFCC">
    <h1>OpenMXチュートリアル</h1>
    <hr>

    ここではOpenMXを使って分子の計算を行う。

    <h3>
      <p><a href="#sdffile">分子構造ファイルを入手する</a></p>
      <p><a href="#sdftoxyz">分子構造ファイルの形式変換</a></p>
      <p><a href="#openmxviewer">OpenMX-viewer</a></p>
      <p><a href="#inputfile">OpenMX入力ファイル</a></p>
      <p><a href="#scp">リモートとのファイルのやり取り</a></p>
      <p><a href="#jobsubmit">ジョブ投入</a></p>
      <p><a href="#outputfile">OpenMX出力ファイルと可視化</a></p>
    </h3>
    <hr>

    <hr />
    <h2 id="sdffile">分子構造ファイルを入手する</h2>

    ここでは題材としてメタン分子を扱う。
    Googleで「Methane Mol-File Mol-Instincts」で検索をする。
    <p><img src="search.jpg" height="300" /></p>
    このように、「www.molinstincts.com」以下のサイトが見つかるので、そこに行く。
    <br />
    このページの中で、以下のように「構造データファイルをダウンロードする(SDF/MOL形式)」という部分があるので、
    そこをクリックするとダウンロードが始まるのだが、今はそのリンクのURLをコピーしておく。
    <p><img src="sdf.png" height="300" /></p>

    次にに以下のようにWSLで作業用のディレクトリを作っておき、そこに入る。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
mkdir -p ~/win/work/methane/
cd ~/win/work/methane/
            </code></pre>
    これはWindows側からも見ることができるフォルダになる。
    ここに、先ほどのSDFファイルをダウンロードする。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
wget 上記でコピーしたリンクのURL
            </code></pre>
    lsコマンドでディレクトリの中身を見ると、名前が.sdfで終わるファイルがあることが分かる。

    <hr />
    <h2 id="sdftoxyz">分子構造ファイルの形式変換</h2>

    得られたSDF形式のファイルをOpenBabelというソフトウェアを使いXYZ形式に変換する。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
sudo apt install openbabel
                   </code></pre>
    macOSの場合はHomeBrew等を用いてインストールする。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
brew install open-babel
                         </code></pre>

    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
babel SDFファイル名 methane.xyz
                   </code></pre>
    こうして新しくmethane.xyzというファイルが作られる。
    それでは「cat methane.xyz」という風にcatコマンドを実行して、このファイルの中身を見てみよう。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
  5
  CT1001789336
  H          0.00210       -0.00410        0.00200
  C         -0.01270        1.08580        0.00800
  H          1.00990        1.46310        0.00030
  H         -0.53990        1.44690       -0.87510
  H         -0.52290        1.43730        0.90480
            </code></pre>
    1行目はこの構造の原子数(今の場合は5個)を表す。
    2行目は「コメント」であり、機械側では意味を持たない覚書のようなものである。
    そのあとは各原子について元素記号とデカルト座標(単位Å)が並んでいる。

    <hr />

    <h2 id="openmxviewer">OpenMX-viewer</h2>

    <a href="http://www.openmx-square.org/viewer/" target="_blank">OpenMX Viewer</a>は上で説明したXYZ形式のような構造データから
    構造の図示を行ったり、OpenMXの入力ファイルの生成を行うことができる。
    Windows側で、ブラウザで上記のページを開き、XYZファイルをドラッグアンドドロップして開く。
    <p><img src="viewer.jpg" height="400" /></p>
    ここでいろいろと操作を試してみたのち、以下のようにして「Save」メニューから「OMX(xyz)」を選んでOpenMXの入力ファイルを出力する。
    <p><img src="save.png" height="400" /></p>
    これを作業用ディレクトリの中に保存する。

    <hr />

    <h2 id="inputfile">OpenMX入力ファイル</h2>

    保存したファイルは「abc.dat」という名前になっていると思うが、これをcatやless等のコマンドで表示してみる。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
#
#  This was generated by OpenMX Viewer

System.CurrrentDirectory         ./
System.Name                     abc
level.of.stdout                   1
level.of.fileout                  1

Species.Number                     2
&lt;Definition.of.Atomic.Species
  H     H6.0-s2p1        H_PBE19
  C     C6.0-s2p2d1      C_PBE19
Definition.of.Atomic.Species&gt;

Atoms.Number                       5
Atoms.SpeciesAndCoordinates.Unit   Ang
&lt;Atoms.SpeciesAndCoordinates
  1     H        0.0021000     -0.0041000      0.0020000    0.5  0.5
  2     C       -0.0127000      1.0858000      0.0080000    2.0  2.0
  3     H        1.0099000      1.4631000      0.0003000    0.5  0.5
  4     H       -0.5399000      1.4469000     -0.8751000    0.5  0.5
  5     H       -0.5229000      1.4373000      0.9048000    0.5  0.5
Atoms.SpeciesAndCoordinates&gt;

Atoms.UnitVectors.Unit             Ang
&lt;Atoms.UnitVectors
  18.0000000   0.0000000   0.0000000
  0.0000000   18.0000000   0.0000000
  0.0000000   0.0000000   18.0000000
Atoms.UnitVectors&gt;

scf.XcType                    GGA-PBE
scf.SpinPolarization          off
scf.ElectronicTemperature     300.0
scf.energycutoff              220.0
scf.maxIter                   100
scf.EigenvalueSolver          band
scf.Kgrid                     1  1  1
scf.Mixing.Type               rmm-diisk
scf.Init.Mixing.Weight        0.05
scf.Min.Mixing.Weight         0.01
scf.Max.Mixing.Weight         0.30
scf.Mixing.History            25
scf.Mixing.StartPulay         15
scf.criterion                 1.0e-7

MD.Type                       nomd
MD.maxIter                    1
MD.TimeStep                   1.0
MD.Opt.criterion              0.0003
            </code></pre>

    このファイルをエディターで開いて以下の行を追記しておく。場所はどこでもよい。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
data.path /home/public/program/openmx/DFT_DATA19/
                  </code></pre>

    入力ファイルのキーワードについては
    <a href="http://www.openmx-square.org/openmx_man3.9jp/node21.html">こちらのマニュアルのページ</a>
    を参照。

    <hr />



    <h2 id="scp">リモートとのファイルのやり取り</h2>

    このabc.datファイルをgaussに送る。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
scp abc.dat ユーザー名@gauss.issp.u-tokyo.ac.jp:~/
                        </code></pre>
    次にsshでgaussにログインしてlsを実行してみると、このabc.datが送られていることが確認できる。
    <br />

    gauss内に作業用ディレクトリを作ってabc.datをそこに移動し、自分もそのディレクトリに行く。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
mkdir -p ~/work/methane/
mv abc.dat ~/work/methane/
cd ~/work/methane/
                        </code></pre>
    <hr />



    <h2 id="jobsubmit">ジョブ投入</h2>

    ここで、前に説明したキューイングシステムを使って、計算ノードにメタン分子の数値計算のジョブを投入する。
    エディターを使い「dft.sh」という名前で次のようにジョブスクリプトを作成する。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
#!/bin/sh
#PBS -l nodes=1:ppn=5
#PBS -n
source ~/.bashrc
export OMP_NUM_THREADS=1
cd $PBS_O_WORKDIR
mpiexec -hostfile $PBS_NODEFILE /home/public/bin/openmx abc.dat -nt $OMP_NUM_THREADS &gt; ${PBS_JOBID}.out 2&gt;&amp;1
               </code></pre>
    これを「qsub dft.sh」で投入する。
    <hr />

    <h2 id="outputfile">OpenMX出力ファイルと可視化</h2>

    ジョブが終わった状態でディレクトリの中身を見てみる。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
[kawamura@gauss met]$ ls
15761.gauss.out  abc.dat   abc.dden.cube  abc.md   abc.out        abc.v0.cube     abc.xyz  dft.sh         dft.sh.o15761
abc.cif          abc.dat#  abc.ene        abc.md2  abc.tden.cube  abc.vhart.cube  abc_rst  dft.sh.e15761
                     </code></pre>
    「15761.gauss.out」や「abc.out」をlessコマンド表示させて、それぞれの項目の意味するところを考える。

    <br />
    PCのほうに戻って、計算結果のcubeファイルをscpでgaussから回収する。
    <pre style="border: 1px solid #000000;background-color: #ffffff;padding-left: 10px;"><code>
scp ユーザー名@gauss.issp.u-tokyo.ac.jp:~/work/methane/*.cube .
            </code></pre>
    これは.cubeで終わるファイルをまとめて持ってくるコマンド。

  </body>
</html>
